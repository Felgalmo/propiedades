<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refrigeration Cycle Simulator with Integrated P-h Diagram</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9;
            color: #1f2937;
        }
        #mainContainer {
            position: relative;
            width: 480px;
            height: 360px;
            margin: 20px auto;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        #cycleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #phCanvas {
            position: absolute;
            top: 51px;
            left: 78px;
            width: 324px;
            height: 233px;
            border: 1px dashed #6b7280;
            z-index: 2;
        }
        #errorMessage {
            color: #dc2626;
            margin: 10px 0;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg mt-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Refrigeration Cycle Simulator</h1>
        <div id="errorMessage"></div>
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Refrigerant:</label>
                <select id="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Evaporator Temp (째C):</label>
                    <input type="number" id="evapTemp" value="-30" step="0.1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Superheat (째C):</label>
                    <input type="number" id="superheat" value="0" step="0.1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Condenser Temp (째C):</label>
                    <input type="number" id="condTemp" value="40" step="0.1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Subcooling (째C):</label>
                    <input type="number" id="subcooling" value="0" step="0.1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cooling Capacity:</label>
                    <input type="number" id="coolingPower" value="1000" step="100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Unit:</label>
                    <select id="coolingUnit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="W" selected>W</option>
                        <option value="Btu/h">Btu/h</option>
                        <option value="kcal/h">kcal/h</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Altitude (m):</label>
                <select id="altitude" onchange="updatePressures()" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="0">0 m</option>
                    <option value="252">252 m</option>
                    <option value="500">500 m</option>
                    <option value="750">750 m</option>
                    <option value="1000">1000 m</option>
                    <option value="1250">1250 m</option>
                    <option value="1500">1500 m</option>
                    <option value="1750">1750 m</option>
                    <option value="2000">2000 m</option>
                    <option value="2250">2250 m</option>
                    <option value="2500">2500 m</option>
                    <option value="2750">2750 m</option>
                    <option value="3000">3000 m</option>
                    <option value="3250">3250 m</option>
                    <option value="3500">3500 m</option>
                    <option value="3750">3750 m</option>
                    <option value="4000">4000 m</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Low Pressure (bar, psi):</label>
                    <span id="presionBaja" class="mt-1 block text-sm text-gray-600">N/A</span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">High Pressure (bar, psi):</label>
                    <span id="presionAlta" class="mt-1 block text-sm text-gray-600">N/A</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">COP:</label>
                    <span id="copValue" class="mt-1 block text-sm text-gray-600">N/A</span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Mass Flow Rate (kg/s):</label>
                    <span id="massFlow" class="mt-1 block text-sm text-gray-600">N/A</span>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="updateThermo()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Calculate</button>
            </div>
        </div>
    </div>
    <div id="mainContainer">
        <canvas id="cycleCanvas" width="480" height="360"></canvas>
        <canvas id="phCanvas" width="324" height="233"></canvas>
    </div>
    <div class="max-w-2xl mx-auto mt-6">
        <table id="capillaryTable" class="w-full border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Diameter (inches)</th>
                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Length (m)</th>
                </tr>
            </thead>
            <tbody id="capillaryTableBody" class="text-sm text-gray-600">
                <!-- Will be populated dynamically -->
            </tbody>
        </table>
    </div>
    
    <script>
        const COMMERCIAL_DIAMETERS_INCHES = {
            0.0007112: 0.028,
            0.0007874: 0.031,
            0.0008382: 0.033,
            0.0009144: 0.036,
            0.0009906: 0.039,
            0.0010668: 0.042,
            0.0011176: 0.044,
            0.0011938: 0.047,
            0.0012446: 0.049,
            0.0013208: 0.052,
            0.001397: 0.055,
            0.0014986: 0.059,
            0.0016256: 0.064,
            0.001778: 0.070
        };

        const cycleCanvas = document.getElementById('cycleCanvas');
        const cycleCtx = cycleCanvas.getContext('2d');
        const phCanvas = document.getElementById('phCanvas');
        const phCtx = phCanvas.getContext('2d');
        const refrigerantSelect = document.getElementById('refrigerant');
        const evapTempInput = document.getElementById('evapTemp');
        const condTempInput = document.getElementById('condTemp');
        const superheatInput = document.getElementById('superheat');
        const subcoolingInput = document.getElementById('subcooling');
        const coolingPowerInput = document.getElementById('coolingPower');
        const coolingUnitSelect = document.getElementById('coolingUnit');
        const copValueSpan = document.getElementById('copValue');
        const massFlowSpan = document.getElementById('massFlow');
        const altitudeSelect = document.getElementById('altitude');
        const presionBajaSpan = document.getElementById('presionBaja');
        const presionAltaSpan = document.getElementById('presionAlta');
        const capillaryTableBody = document.getElementById('capillaryTableBody');
        const errorMessageDiv = document.getElementById('errorMessage');

        const x1 = 30, x2 = 450, y1 = 30, y2 = 330, pipeThickness = 18;
        const fanRadius = 24;
        let fanAngle = 0;

        const condenserImg = new Image(); condenserImg.src = 'condensadordef.png';
        const evaporatorImg = new Image(); evaporatorImg.src = 'evaporadordef.png';
        const compressorImg = new Image(); compressorImg.src = 'compressor.png';
        const expansionImg = new Image(); expansionImg.src = 'expansionsimulador.png';

        let thermoData = {
            refrigerant: 'R134a',
            evap_temp: 243.15,
            cond_temp: 313.15,
            superheat: 0,
            subcooling: 0,
            cop: 0,
            mass_flow: 0,
            points: {
                '1': { pressure: 0, enthalpy: 0, temperature: 0, density: 0 },
                '2': { pressure: 0, enthalpy: 0, temperature: 0, density: 0 },
                '3': { pressure: 0, enthalpy: 0, temperature: 0, density: 0 },
                '4': { pressure: 0, enthalpy: 0, temperature: 0, density: 0 }
            },
            saturation: { liquid: [], vapor: [] },
            capillary_lengths: []
        };

        async function loadRefrigerants(attempt = 1, maxAttempts = 3) {
            console.log(`Attempting to load refrigerants, attempt ${attempt}/${maxAttempts}`);
            errorMessageDiv.textContent = '';
            try {
                const response = await fetch('/refrigerants', { method: 'GET', headers: { 'Accept': 'application/json' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log('Response from /refrigerants:', data);
                if (data.status === 'success' && Array.isArray(data.refrigerants)) {
                    refrigerantSelect.innerHTML = '';
                    data.refrigerants.forEach(refrigerant => {
                        const option = document.createElement('option');
                        option.value = refrigerant;
                        option.textContent = refrigerant;
                        if (refrigerant === 'R134a') option.selected = true;
                        refrigerantSelect.appendChild(option);
                    });
                    console.log('Refrigerants loaded successfully');
                    updateThermo();
                } else {
                    throw new Error(data.message || 'Invalid server response');
                }
            } catch (error) {
                console.error('Error loading refrigerants:', error);
                if (attempt < maxAttempts) {
                    console.log(`Retrying refrigerant load in 1 second...`);
                    setTimeout(() => loadRefrigerants(attempt + 1, maxAttempts), 1000);
                } else {
                    errorMessageDiv.textContent = 'Error loading refrigerants: ' + error.message;
                    refrigerantSelect.innerHTML = '<option value="">Error loading</option>';
                }
            }
        }

        async function fetchThermoProperties() {
            console.log('Fetching data from backend...');
            errorMessageDiv.textContent = '';
            const evapTemp = parseFloat(evapTempInput.value);
            const condTemp = parseFloat(condTempInput.value);
            const superheat = parseFloat(superheatInput.value);
            const subcooling = parseFloat(subcoolingInput.value);
            const coolingPower = parseFloat(coolingPowerInput.value);
            const coolingUnit = coolingUnitSelect.value;

            if (isNaN(evapTemp) || isNaN(condTemp) || isNaN(superheat) || isNaN(subcooling) || isNaN(coolingPower)) {
                throw new Error('Please enter valid numeric values');
            }
            if (condTemp <= evapTemp) {
                throw new Error('Condenser temperature must be higher than evaporator temperature');
            }
            if (superheat < 0 || subcooling < 0) {
                throw new Error('Superheat and subcooling cannot be negative');
            }
            if (coolingPower <= 0) {
                throw new Error('Cooling capacity must be greater than zero');
            }

            const evapTempK = evapTemp + 273.15;
            const condTempK = condTemp + 273.15;

            try {
                const response = await fetch('/thermo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({
                        refrigerant: refrigerantSelect.value,
                        evap_temp: evapTempK,
                        cond_temp: condTempK,
                        superheat: superheat,
                        subcooling: subcooling,
                        cooling_power: { value: coolingPower, unit: coolingUnit }
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log('Response from /thermo:', data);
                if (data.status === 'success') {
                    thermoData = data;
                    copValueSpan.textContent = thermoData.cop.toFixed(2);
                    massFlowSpan.textContent = thermoData.mass_flow.toFixed(4);
                    updatePressures();
                    updateCapillaryTable();
                    drawPHDiagram();
                } else {
                    throw new Error(data.message || 'Calculation error');
                }
            } catch (error) {
                console.error('Error connecting to backend:', error);
                errorMessageDiv.textContent = 'Error calculating: ' + error.message;
                copValueSpan.textContent = 'N/A';
                massFlowSpan.textContent = 'N/A';
                presionBajaSpan.textContent = 'N/A';
                presionAltaSpan.textContent = 'N/A';
                capillaryTableBody.innerHTML = '';
                throw error;
            }
        }

        function updateCapillaryTable() {
            capillaryTableBody.innerHTML = '';
            if (thermoData.capillary && Array.isArray(thermoData.capillary.capillary_lengths)) {
                thermoData.capillary.capillary_lengths.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    const diameterCell = document.createElement('td');
                    diameterCell.className = 'py-2 px-4';
                    const diameterMeters = item.diameter_mm / 1000;
                    const diameterInches = COMMERCIAL_DIAMETERS_INCHES[diameterMeters] || (diameterMeters / 0.0254).toFixed(3);
                    diameterCell.textContent = diameterInches.toFixed(3);
                    const lengthCell = document.createElement('td');
                    lengthCell.className = 'py-2 px-4';
                    lengthCell.textContent = typeof item.length_m === 'number' ? item.length_m.toFixed(2) : item.length_m;
                    row.appendChild(diameterCell);
                    row.appendChild(lengthCell);
                    capillaryTableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.className = 'py-2 px-4 text-center';
                cell.textContent = 'No capillary data available';
                row.appendChild(cell);
                capillaryTableBody.appendChild(row);
            }
        }

        function getPresionAtmosferica(altura) {
            const P0 = 1.01325;
            const factor = 0.00012;
            return P0 * Math.exp(-factor * altura);
        }

        function updatePressures() {
            const altura = parseInt(altitudeSelect.value);
            const presionAtm = getPresionAtmosferica(altura);
            const P2 = thermoData.points['2'].pressure / 100000;
            const P3 = thermoData.points['3'].pressure / 100000;
            const presionBaja = P2 - presionAtm;
            const presionAlta = P3 - presionAtm;
            const presionBajaPsi = (presionBaja * 14.5038).toFixed(2);
            const presionAltaPsi = (presionAlta * 14.5038).toFixed(2);

            presionBajaSpan.textContent = `${presionBaja.toFixed(2)} bar, ${presionBajaPsi} psi`;
            presionAltaSpan.textContent = `${presionAlta.toFixed(2)} bar, ${presionAltaPsi} psi`;
        }

        async function updateThermo() {
            if (!refrigerantSelect.value) {
                errorMessageDiv.textContent = 'Please select a refrigerant';
                return;
            }
            try {
                await fetchThermoProperties();
                console.log('Data updated, redrawing...');
                drawCycle();
                drawPHDiagram();
                updatePressures();
            } catch (error) {
                console.error('Error updating:', error);
                errorMessageDiv.textContent = 'Error updating: ' + error.message;
            }
        }

        function getPhase(point, pointId) {
            const pressure = point.pressure;
            const enthalpy = point.enthalpy;

            const saturationLiquid = thermoData.saturation.liquid.find(p => Math.abs(p.pressure - pressure) < 10000) || thermoData.saturation.liquid[0];
            const saturationVapor = thermoData.saturation.vapor.find(p => Math.abs(p.pressure - pressure) < 10000) || thermoData.saturation.vapor[0];

            if (!saturationLiquid || !saturationVapor) return "Unknown";

            const hLiquid = saturationLiquid.enthalpy;
            const hVapor = saturationVapor.enthalpy;
            const margin = 2000;

            if (pointId === '2' && thermoData.superheat > 0) return "Superheated Vapor";
            if (pointId === '4' && thermoData.subcooling > 0) return "Subcooled Liquid";

            if (enthalpy < hLiquid - margin) return "Subcooled Liquid";
            else if (Math.abs(enthalpy - hLiquid) <= margin) return "Saturated Liquid";
            else if (enthalpy > hLiquid + margin && enthalpy < hVapor - margin) return "Liquid-Vapor Mixture";
            else if (Math.abs(enthalpy - hVapor) <= margin) return "Saturated Vapor";
            else if (enthalpy > hVapor + margin) return "Superheated Vapor";
            return "Unknown";
        }

        class Particle {
            constructor() { 
                this.reset(); 
                this.size = 4.2;
                this.speed = 1.2 + Math.random() * 1.2;
            }
            reset() { 
                this.x = x1; 
                this.y = y1 + pipeThickness/2; 
                this.segment = 8; 
                this.distance = 0; 
                this.offset = (Math.random() - 0.5) * (pipeThickness - this.size * 2); 
            }
            move() {
                this.distance += this.speed;
                switch(this.segment) {
                    case 8: this.x = x1 + pipeThickness/2 + this.offset; this.y = y1 + pipeThickness/2 + this.distance; if (this.y >= y2/2) this.nextSegment(); break;
                    case 7: this.x = x1 + pipeThickness/2 + this.offset; this.y = y2/2 + this.distance; if (this.y >= y2 - pipeThickness/2) this.nextSegment(); break;
                    case 6: this.x = x1 + pipeThickness/2 + this.distance; this.y = y2 - pipeThickness/2 + this.offset; if (this.x >= x2/2) this.nextSegment(); break;
                    case 5: this.x = x2/2 + this.distance; this.y = y2 - pipeThickness/2 + this.offset; if (this.x >= x2 - pipeThickness/2) this.nextSegment(); break;
                    case 4: this.x = x2 - pipeThickness/2 + this.offset; this.y = y2 - pipeThickness/2 - this.distance; if (this.y <= y2/2) this.nextSegment(); break;
                    case 3: this.x = x2 - pipeThickness/2 + this.offset; this.y = y2/2 - this.distance; if (this.y <= y1 + pipeThickness/2) this.nextSegment(); break;
                    case 2: this.x = x2 - pipeThickness/2 - this.distance; this.y = y1 + pipeThickness/2 + this.offset; if (this.x <= x2/2) this.nextSegment(); break;
                    case 1: this.x = x2/2 - this.distance; this.y = y1 + pipeThickness/2 + this.offset; if (this.x <= x1 + pipeThickness/2) this.reset(); break;
                }
            }
            nextSegment() {
                this.segment--; 
                this.distance = 0;
                switch(this.segment) {
                    case 7: this.x = x1 + pipeThickness/2 + this.offset; this.y = y2/2; break;
                    case 6: this.x = x1 + pipeThickness/2; this.y = y2 - pipeThickness/2 + this.offset; break;
                    case 5: this.x = x2/2; this.y = y2 - pipeThickness/2 + this.offset; break;
                    case 4: this.x = x2 - pipeThickness/2 + this.offset; this.y = y2 - pipeThickness/2; break;
                    case 3: this.x = x2 - pipeThickness/2 + this.offset; this.y = y2/2; break;
                    case 2: this.x = x2 - pipeThickness/2; this.y = y1 + pipeThickness/2 + this.offset; break;
                    case 1: this.x = x2/2; this.y = y1 + pipeThickness/2 + this.offset; break;
                }
            }
            draw() {
                cycleCtx.beginPath();
                cycleCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                switch(this.segment) {
                    case 1: case 8: cycleCtx.fillStyle = 'orange'; break;
                    case 7: case 6: cycleCtx.fillStyle = 'darkblue'; break;
                    case 5: case 4: cycleCtx.fillStyle = 'lightblue'; break;
                    case 3: case 2: cycleCtx.fillStyle = 'red'; break;
                }
                cycleCtx.fill();
                cycleCtx.closePath();
            }
        }

        const particles = [];
        for (let i = 0; i < 15; i++) {
            particles.push(new Particle());
            for (let j = 0; j < i * 12; j++) particles[i].move();
        }

        function drawFanBlade(ctx, centerX, centerY, angle) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(fanRadius, fanRadius / 2);
            ctx.lineTo(fanRadius, -fanRadius / 2);
            ctx.closePath();
            ctx.fillStyle = 'gray';
            ctx.fill();
            ctx.restore();
        }

        function drawCycle() {
            cycleCtx.clearRect(0, 0, cycleCanvas.width, cycleCanvas.height);

            cycleCtx.beginPath();
            cycleCtx.lineWidth = pipeThickness;
            cycleCtx.strokeStyle = '#43464B';
            cycleCtx.moveTo(x1 + pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.lineTo(x2 - pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.lineTo(x2 - pipeThickness/2, y2 - pipeThickness/2);
            cycleCtx.lineTo(x1 + pipeThickness/2, y2 - pipeThickness/2);
            cycleCtx.lineTo(x1 + pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.closePath();
            cycleCtx.stroke();

            const condenserWidth = 120, condenserHeight = 60;
            const evaporatorWidth = 120, evaporatorHeight = 60;
            const compressorWidth = 72, compressorHeight = 72;
            const expansionWidth = 72, expansionHeight = 36;

            const condenserX = (x1 + x2) / 2 - condenserWidth / 2;
            const condenserY = y1 + pipeThickness / 2 - condenserHeight / 2;
            if (condenserImg.complete && condenserImg.naturalWidth !== 0) {
                cycleCtx.drawImage(condenserImg, condenserX, condenserY, condenserWidth, condenserHeight);
            } else {
                cycleCtx.fillStyle = 'gray';
                cycleCtx.fillRect(condenserX, condenserY, condenserWidth, condenserHeight);
            }
            const fanCenterX1 = condenserX + condenserWidth / 4, fanCenterY1 = condenserY + condenserHeight / 2;
            drawFanBlade(cycleCtx, fanCenterX1, fanCenterY1, fanAngle);
            drawFanBlade(cycleCtx, fanCenterX1, fanCenterY1, fanAngle + (2 * Math.PI / 3));
            drawFanBlade(cycleCtx, fanCenterX1, fanCenterY1, fanAngle + (4 * Math.PI / 3));
            const fanCenterX2 = condenserX + 3 * condenserWidth / 4, fanCenterY2 = condenserY + condenserHeight / 2;
            drawFanBlade(cycleCtx, fanCenterX2, fanCenterY2, fanAngle);
            drawFanBlade(cycleCtx, fanCenterX2, fanCenterY2, fanAngle + (2 * Math.PI / 3));
            drawFanBlade(cycleCtx, fanCenterX2, fanCenterY2, fanAngle + (4 * Math.PI / 3));

            const evaporatorX = (x1 + x2) / 2 - evaporatorWidth / 2;
            const evaporatorY = y2 - pipeThickness / 2 - evaporatorHeight / 2;
            if (evaporatorImg.complete && evaporatorImg.naturalWidth !== 0) {
                cycleCtx.drawImage(evaporatorImg, evaporatorX, evaporatorY, evaporatorWidth, evaporatorHeight);
            } else {
                cycleCtx.fillStyle = 'gray';
                cycleCtx.fillRect(evaporatorX, evaporatorY, evaporatorWidth, evaporatorHeight);
            }
            const fanCenterX3 = evaporatorX + evaporatorWidth / 4, fanCenterY3 = evaporatorY + evaporatorHeight / 2;
            drawFanBlade(cycleCtx, fanCenterX3, fanCenterY3, fanAngle);
            drawFanBlade(cycleCtx, fanCenterX3, fanCenterY3, fanAngle + (2 * Math.PI / 3));
            drawFanBlade(cycleCtx, fanCenterX3, fanCenterY3, fanAngle + (4 * Math.PI / 3));
            const fanCenterX4 = evaporatorX + 3 * evaporatorWidth / 4, fanCenterY4 = evaporatorY + evaporatorHeight / 2;
            drawFanBlade(cycleCtx, fanCenterX4, fanCenterY4, fanAngle);
            drawFanBlade(cycleCtx, fanCenterX4, fanCenterY4, fanAngle + (2 * Math.PI / 3));
            drawFanBlade(cycleCtx, fanCenterX4, fanCenterY4, fanAngle + (4 * Math.PI / 3));

            const compressorX = x2 - pipeThickness / 2 - compressorWidth / 2;
            const compressorY = (y1 + y2) / 2 - compressorHeight / 2;
            if (compressorImg.complete && compressorImg.naturalWidth !== 0) {
                cycleCtx.drawImage(compressorImg, compressorX, compressorY, compressorWidth, compressorHeight);
            } else {
                cycleCtx.fillStyle = 'gray';
                cycleCtx.fillRect(compressorX, compressorY, compressorWidth, compressorHeight);
            }

            const expansionX = x1 + pipeThickness / 2 - expansionWidth / 2;
            const expansionY = (y1 + y2) / 2 - expansionHeight / 2;
            if (expansionImg.complete && expansionImg.naturalWidth !== 0) {
                cycleCtx.drawImage(expansionImg, expansionX, expansionY, expansionWidth, expansionHeight);
            } else {
                cycleCtx.fillStyle = 'gray';
                cycleCtx.fillRect(expansionX, expansionY, expansionWidth, expansionHeight);
            }

            particles.forEach(particle => {
                particle.move();
                particle.draw();
            });
        }

        let mouseX = -100, mouseY = -100;
        let hoveredPoint = null;

        phCanvas.addEventListener('mousemove', (event) => {
            const rect = phCanvas.getBoundingClientRect();
            mouseX = event.clientX - rect.left;
            mouseY = event.clientY - rect.top;
            drawPHDiagram();
        });

        phCanvas.addEventListener('mouseout', () => {
            mouseX = -100;
            mouseY = -100;
            hoveredPoint = null;
            drawPHDiagram();
        });

        function getPointsPH() {
            const cyclePoints = [
                thermoData.points['1'],
                thermoData.points['2'],
                thermoData.points['3'],
                thermoData.points['4']
            ];
            const cyclePressures = cyclePoints.map(p => p.pressure);
            const cycleEnthalpies = cyclePoints.map(h => h.enthalpy);

            const minP = Math.min(...cyclePressures) * 0.8;
            const maxP = Math.max(...cyclePressures) * 1.2;
            const minH = Math.min(...cycleEnthalpies) * 0.9;
            const maxH = Math.max(...cycleEnthalpies) * 1.1;

            const marginX = 32.4;
            const marginY = 25.92;
            const plotWidth = 324 - 2 * marginX;
            const plotHeight = 233 - 2 * marginY;

            function scaleX(h) { return marginX + (h - minH) / (maxH - minH) * plotWidth; }
            function scaleY(p) { return marginY + plotHeight - (Math.log(p) - Math.log(minP)) / (Math.log(maxP) - Math.log(minP)) * plotHeight; }

            return [
                { x: scaleX(cyclePoints[0].enthalpy), y: scaleY(cyclePoints[0].pressure), label: '1', temp: cyclePoints[0].temperature, density: cyclePoints[0].density },
                { x: scaleX(cyclePoints[1].enthalpy), y: scaleY(cyclePoints[1].pressure), label: '2', temp: cyclePoints[1].temperature, density: cyclePoints[1].density },
                { x: scaleX(cyclePoints[2].enthalpy), y: scaleY(cyclePoints[2].pressure), label: '3', temp: cyclePoints[2].temperature, density: cyclePoints[2].density },
                { x: scaleX(cyclePoints[3].enthalpy), y: scaleY(cyclePoints[3].pressure), label: '4', temp: cyclePoints[3].temperature, density: cyclePoints[3].density }
            ];
        }

        function drawPHDiagram() {
            const pixelRatio = window.devicePixelRatio || 1;
            phCanvas.width = 324 * pixelRatio;
            phCanvas.height = 233 * pixelRatio;
            phCtx.scale(pixelRatio, pixelRatio);

            phCtx.clearRect(0, 0, 324, 233);

            const marginX = 32.4;
            const marginY = 25.92;
            const plotWidth = 324 - 2 * marginX;
            const plotHeight = 233 - 2 * marginY;

            const cyclePoints = [
                thermoData.points['1'],
                thermoData.points['2'],
                thermoData.points['3'],
                thermoData.points['4']
            ];
            const cyclePressures = cyclePoints.map(p => p.pressure);
            const cycleEnthalpies = cyclePoints.map(h => h.enthalpy);

            const minP = Math.min(...cyclePressures) * 0.8;
            const maxP = Math.max(...cyclePressures) * 1.2;
            const minH = Math.min(...cycleEnthalpies) * 0.9;
            const maxH = Math.max(...cycleEnthalpies) * 1.1;

            function scaleX(h) { return marginX + (h - minH) / (maxH - minH) * plotWidth; }
            function scaleY(p) { return marginY + plotHeight - (Math.log(p) - Math.log(minP)) / (Math.log(maxP) - Math.log(minP)) * plotHeight; }

            phCtx.beginPath();
            phCtx.moveTo(marginX, marginY);
            phCtx.lineTo(marginX, marginY + plotHeight);
            phCtx.lineTo(marginX + plotWidth, marginY + plotHeight);
            phCtx.strokeStyle = 'black';
            phCtx.lineWidth = 1.08;
            phCtx.stroke();

            phCtx.font = '14.4px Arial';
            phCtx.fillStyle = 'black';
            phCtx.fillText('Pressure (bar)', marginX - 32.4, marginY - 10);
            phCtx.fillText('Enthalpy (kJ/kg)', marginX + plotWidth - 80, marginY + plotHeight + 15);

            const logMinP = Math.log(minP);
            const logMaxP = Math.log(maxP);
            const numPressureTicks = 6;
            for (let i = 0; i < numPressureTicks; i++) {
                const logP = logMinP + (logMaxP - logMinP) * i / (numPressureTicks - 1);
                const p = Math.exp(logP);
                const y = scaleY(p);
                phCtx.beginPath();
                phCtx.moveTo(marginX - 5.4, y);
                phCtx.lineTo(marginX + 5.4, y);
                phCtx.stroke();
                phCtx.fillText((p / 100000).toFixed(1), marginX - 32.4, y + 5.4);
            }

            const numEnthalpyTicks = 6;
            const hStep = (maxH - minH) / (numEnthalpyTicks - 1);
            for (let i = 0; i < numEnthalpyTicks; i++) {
                const h = minH + i * hStep;
                const x = scaleX(h);
                phCtx.beginPath();
                phCtx.moveTo(x, marginY + plotHeight - 5.4);
                phCtx.lineTo(x, marginY + plotHeight + 5.4);
                phCtx.stroke();
                phCtx.fillText((h / 1000).toFixed(0), x - 8.1, marginY + plotHeight + 10.8);
            }

            if (thermoData.saturation.liquid.length > 0) {
                phCtx.beginPath();
                thermoData.saturation.liquid.forEach((point, index) => {
                    const x = scaleX(point.enthalpy);
                    const y = scaleY(point.pressure);
                    if (index === 0) phCtx.moveTo(x, y);
                    else phCtx.lineTo(x, y);
                });
                phCtx.strokeStyle = 'green';
                phCtx.lineWidth = 1.62;
                phCtx.stroke();
            }

            if (thermoData.saturation.vapor.length > 0) {
                phCtx.beginPath();
                thermoData.saturation.vapor.forEach((point, index) => {
                    const x = scaleX(point.enthalpy);
                    const y = scaleY(point.pressure);
                    if (index === 0) phCtx.moveTo(x, y);
                    else phCtx.lineTo(x, y);
                });
                phCtx.strokeStyle = 'purple';
                phCtx.lineWidth = 1.62;
                phCtx.stroke();
            }

            const pointsPH = getPointsPH();
            if (pointsPH.length === 4) {
                phCtx.beginPath();
                pointsPH.forEach((point, index) => {
                    if (index === 0) phCtx.moveTo(point.x, point.y);
                    else phCtx.lineTo(point.x, point.y);
                });
                phCtx.lineTo(pointsPH[0].x, pointsPH[0].y);
                phCtx.strokeStyle = 'blue';
                phCtx.lineWidth = 2.16;
                phCtx.stroke();

                pointsPH.forEach(point => {
                    phCtx.beginPath();
                    phCtx.arc(point.x, point.y, 3.24, 0, Math.PI * 2);
                    phCtx.fillStyle = 'red';
                    phCtx.fill();
                    phCtx.font = '12.6px Arial';
                    phCtx.fillStyle = 'black';
                    const tempC = (point.temp - 273.15).toFixed(1);
                    phCtx.fillText(`P${point.label} (${tempC}째C)`, point.x + 5.4, point.y - 4.32);

                    const dx = mouseX - point.x;
                    const dy = mouseY - point.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 10) {
                        hoveredPoint = point.label;
                    }
                });

                if (hoveredPoint) {
                    const point = pointsPH.find(p => p.label === hoveredPoint);
                    const thermoPoint = thermoData.points[hoveredPoint];
                    const text = [
                        `Point ${hoveredPoint}`,
                        `Pressure: ${(thermoPoint.pressure / 100000).toFixed(2)} bar`,
                        `Temperature: ${(thermoPoint.temperature - 273.15).toFixed(1)}째C`,
                        `Enthalpy: ${(thermoPoint.enthalpy / 1000).toFixed(1)} kJ/kg`,
                        `Density: ${thermoPoint.density.toFixed(1)} kg/m쨀`,
                        `Phase: ${getPhase(thermoPoint, hoveredPoint)}`
                    ].join('\n');
                    const textWidth = Math.max(...text.split('\n').map(line => phCtx.measureText(line).width));
                    const textHeight = 6 * 12.6;
                    const boxX = point.x + 10;
                    const boxY = point.y - textHeight - 10;
                    phCtx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    phCtx.fillRect(boxX, boxY, textWidth + 10, textHeight + 10);
                    phCtx.strokeStyle = 'black';
                    phCtx.strokeRect(boxX, boxY, textWidth + 10, textHeight + 10);
                    phCtx.fillStyle = 'black';
                    phCtx.font = '12.6px Arial';
                    text.split('\n').forEach((line, index) => {
                        phCtx.fillText(line, boxX + 5, boxY + 12.6 * (index + 1));
                    });
                }
            }
        }

        function animate() {
            fanAngle += 0.05;
            drawCycle();
            requestAnimationFrame(animate);
        }

        loadRefrigerants();
        animate();
    </script>
</body>
</html>
