<!DOCTYPE html>
<html>
<head>
    <title>Simulador de Refrigeración con Diagrama P-h Integrado</title>
    <style>
        #mainContainer { 
            position: relative; 
            width: 480px;
            height: 360px;
            margin: 20px auto; 
            border: 1px solid black; 
            background-color: #f0f0f0; 
        }
        #cycleCanvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        #phCanvas { 
            position: absolute; 
            top: 51px; 
            left: 78px; 
            width: 324px; 
            height: 233px; 
            border: 1px dashed black; 
            z-index: 2; 
        }
        #controls { 
            font-family: Arial, sans-serif; 
            margin: 10px auto; 
            width: 480px;
            text-align: left; 
        }
        select, input { 
            margin: 5px 10px 5px 0; 
            width: 60px;
        }
        label { 
            margin-right: 5px; 
        }
        .control-row, .output-row {
            margin-bottom: 10px;
        }
        /* Animación del flujo */
        .refrigerant-flow {
            stroke-dasharray: 10;
            animation: flow 1.5s linear infinite;
        }
        @keyframes flow {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -20; }
        }
        /* Animación de ventiladores */
        .fan {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="controls">
        <div class="control-row">
            <strong>Condiciones del Ciclo de Refrigeración</strong>
        </div>
        <div class="control-row">
            <label>Refrigerante: </label>
            <select id="refrigerant"></select>
        </div>
        <div class="control-row">
            <label>T. Evap (°C): </label><input type="number" id="evapTemp" value="-30" step="0.1">
            <label>Superheat (°C): </label><input type="number" id="superheat" value="0" step="0.1">
        </div>
        <div class="control-row">
            <label>T. Cond (°C): </label><input type="number" id="condTemp" value="40" step="0.1">
            <label>Subcooling (°C): </label><input type="number" id="subcooling" value="0" step="0.1">
        </div>
        <div class="control-row">
            <label>Altura (m): </label>
            <select id="altitude" onchange="updatePressures()">
                <option value="0">0</option><option value="252">252</option><option value="500">500</option><option value="750">750</option>
                <option value="1000">1000</option><option value="1250">1250</option><option value="1500">1500</option>
                <option value="1750">1750</option><option value="2000">2000</option><option value="2250">2250</option>
                <option value="2500">2500</option><option value="2750">2750</option><option value="3000">3000</option>
                <option value="3250">3250</option><option value="3500">3500</option><option value="3750">3750</option>
                <option value="4000">4000</option>
            </select>
        </div>
        <div class="output-row">
            <label>Presión Baja (bar psi): </label><span id="presionBaja">N/A</span>
        </div>
        <div class="output-row">
            <label>Presión Alta (bar psi): </label><span id="presionAlta">N/A</span>
        </div>
        <div class="output-row">
            <label>COP: </label><span id="copValue">N/A</span>
        </div>
        <div class="control-row">
            <button onclick="updateThermo()">Calcular</button>
        </div>
    </div>
    <div id="mainContainer">
        <canvas id="cycleCanvas" width="480" height="360"></canvas>
        <canvas id="phCanvas" width="324" height="233"></canvas>
    </div>
    
    <script>
        const cycleCanvas = document.getElementById('cycleCanvas');
        const cycleCtx = cycleCanvas.getContext('2d');
        const phCanvas = document.getElementById('phCanvas');
        const phCtx = phCanvas.getContext('2d');
        const refrigerantSelect = document.getElementById('refrigerant');
        const evapTempInput = document.getElementById('evapTemp');
        const condTempInput = document.getElementById('condTemp');
        const superheatInput = document.getElementById('superheat');
        const subcoolingInput = document.getElementById('subcooling');
        const copValueSpan = document.getElementById('copValue');
        const altitudeSelect = document.getElementById('altitude');
        const presionBajaSpan = document.getElementById('presionBaja');
        const presionAltaSpan = document.getElementById('presionAlta');

        const x1 = 30, x2 = 450, y1 = 30, y2 = 330, pipeThickness = 18;
        const fanRadius = 24;
        let fanAngle = 0;

        const condenserImg = new Image(); condenserImg.src = 'condensadordef.png';
        const evaporatorImg = new Image(); evaporatorImg.src = 'evaporadordef.png';
        const compressorImg = new Image(); compressorImg.src = 'compressor.png';
        const expansionImg = new Image(); expansionImg.src = 'expansionsimulador.png';

        let thermoData = {
            refrigerant: 'R134a',
            evap_temp: 243.15,
            cond_temp: 313.15,
            superheat: 0,
            subcooling: 0,
            cop: 0,
            points: {
                '1': { pressure: 0, enthalpy: 0, temperature: 0 },
                '2': { pressure: 0, enthalpy: 0, temperature: 0 },
                '3': { pressure: 0, enthalpy: 0, temperature: 0 },
                '4': { pressure: 0, enthalpy: 0, temperature: 0 }
            },
            saturation: { liquid: [], vapor: [] }
        };

        async function loadRefrigerants() {
            try {
                const response = await fetch('/refrigerants');
                const data = await response.json();
                if (data.status === 'success') {
                    refrigerantSelect.innerHTML = '';
                    data.refrigerants.forEach(refrigerant => {
                        const option = document.createElement('option');
                        option.value = refrigerant;
                        option.textContent = refrigerant;
                        if (refrigerant === 'R134a') option.selected = true;
                        refrigerantSelect.appendChild(option);
                    });
                    console.log('Refrigerantes cargados:', data.refrigerants.length);
                } else {
                    console.error('Error al cargar refrigerantes:', data.message);
                }
            } catch (error) {
                console.error('Error al conectar con /refrigerants:', error);
            }
        }

        async function fetchThermoProperties() {
            const evapTempK = parseFloat(evapTempInput.value) + 273.15;
            const condTempK = parseFloat(condTempInput.value) + 273.15;
            const superheat = parseFloat(superheatInput.value);
            const subcooling = parseFloat(subcoolingInput.value);

            try {
                const response = await fetch('/thermo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        refrigerant: refrigerantSelect.value,
                        evap_temp: evapTempK,
                        cond_temp: condTempK,
                        superheat: superheat,
                        subcooling: subcooling
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    thermoData = data;
                    console.log('Datos termo recibidos:', thermoData);
                    copValueSpan.textContent = thermoData.cop.toFixed(2);
                    updatePressures();
                    drawPHDiagram();
                } else {
                    console.error('Error en /thermo:', data.message);
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error al conectar con /thermo:', error);
                alert('No se pudo conectar al servidor');
            }
        }

        function getPresionAtmosferica(altura) {
            const P0 = 1.01325;
            const factor = 0.00012;
            return P0 * Math.exp(-factor * altura);
        }

        function updatePressures() {
            const altura = parseInt(altitudeSelect.value);
            const presionAtm = getPresionAtmosferica(altura);
            const P2 = thermoData.points['2'].pressure / 100000;
            const P3 = thermoData.points['3'].pressure / 100000;
            const presionBaja = P2 - presionAtm;
            const presionAlta = P3 - presionAtm;
            const presionBajaPsi = (presionBaja * 14.5038).toFixed(2);
            const presionAltaPsi = (presionAlta * 14.5038).toFixed(2);
            presionBajaSpan.textContent = `${presionBaja.toFixed(2)} bar, ${presionBajaPsi} psi`;
            presionAltaSpan.textContent = `${presionAlta.toFixed(2)} bar, ${presionAltaPsi} psi`;
        }

        function updateThermo() {
            fetchThermoProperties();
        }

        function getPhase(point, pointId) {
            const pressure = point.pressure;
            const enthalpy = point.enthalpy;
            const saturationLiquid = thermoData.saturation.liquid.find(p => Math.abs(p.pressure - pressure) < 10000) || thermoData.saturation.liquid[0];
            const saturationVapor = thermoData.saturation.vapor.find(p => Math.abs(p.pressure - pressure) < 10000) || thermoData.saturation.vapor[0];

            if (!saturationLiquid || !saturationVapor) return "Desconocido";
            const hLiquid = saturationLiquid.enthalpy;
            const hVapor = saturationVapor.enthalpy;
            const margin = 2000;

            if (pointId === '2' && thermoData.superheat > 0) return "Vapor Sobrecalentado";
            if (pointId === '4' && thermoData.subcooling > 0) return "Líquido Subenfriado";
            if (enthalpy < hLiquid - margin) return "Líquido Subenfriado";
            else if (Math.abs(enthalpy - hLiquid) <= margin) return "Líquido Saturado";
            else if (enthalpy > hLiquid + margin && enthalpy < hVapor - margin) return "Mezcla";
            else if (Math.abs(enthalpy - hVapor) <= margin) return "Vapor Saturado";
            else if (enthalpy > hVapor + margin) return "Vapor Sobrecalentado";
            return "Desconocido";
        }

        function drawFan(ctx, centerX, centerY, angle) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.arc(0, 0, fanRadius, 0, Math.PI * 2);
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.stroke();
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(fanRadius * 0.8, 0);
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.rotate(Math.PI / 2);
            }
            ctx.restore();
        }

        function drawCycle() {
            cycleCtx.clearRect(0, 0, cycleCanvas.width, cycleCanvas.height);

            // Tuberías base
            cycleCtx.beginPath();
            cycleCtx.lineWidth = pipeThickness;
            cycleCtx.strokeStyle = '#43464B';
            cycleCtx.moveTo(x1 + pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.lineTo(x2 - pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.lineTo(x2 - pipeThickness/2, y2 - pipeThickness/2);
            cycleCtx.lineTo(x1 + pipeThickness/2, y2 - pipeThickness/2);
            cycleCtx.lineTo(x1 + pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.stroke();

            // Flujo de refrigerante animado
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;

            // Segmento 1-2 (Evaporador a Compresor)
            cycleCtx.beginPath();
            cycleCtx.moveTo(midX, y2 - pipeThickness/2);
            cycleCtx.lineTo(x2 - pipeThickness/2, midY);
            cycleCtx.strokeStyle = 'darkblue';
            cycleCtx.lineWidth = pipeThickness - 4;
            cycleCtx.setLineDash([10, 10]);
            cycleCtx.stroke();
            cycleCtx.setLineDash([]);

            // Segmento 2-3 (Compresor a Condensador)
            cycleCtx.beginPath();
            cycleCtx.moveTo(x2 - pipeThickness/2, midY);
            cycleCtx.lineTo(x2 - pipeThickness/2, y1 + pipeThickness/2);
            cycleCtx.lineTo(midX, y1 + pipeThickness/2);
            cycleCtx.strokeStyle = 'red';
            cycleCtx.lineWidth = pipeThickness - 4;
            cycleCtx.setLineDash([10, 10]);
            cycleCtx.stroke();
            cycleCtx.setLineDash([]);

            // Segmento 3-4 (Condensador a Válvula)
            cycleCtx.beginPath();
            cycleCtx.moveTo(midX, y1 + pipeThickness/2);
            cycleCtx.lineTo(x1 + pipeThickness/2, midY);
            cycleCtx.strokeStyle = 'orange';
            cycleCtx.lineWidth = pipeThickness - 4;
            cycleCtx.setLineDash([10, 10]);
            cycleCtx.stroke();
            cycleCtx.setLineDash([]);

            // Segmento 4-1 (Válvula a Evaporador)
            cycleCtx.beginPath();
            cycleCtx.moveTo(x1 + pipeThickness/2, midY);
            cycleCtx.lineTo(x1 + pipeThickness/2, y2 - pipeThickness/2);
            cycleCtx.lineTo(midX, y2 - pipeThickness/2);
            cycleCtx.strokeStyle = 'lightblue';
            cycleCtx.lineWidth = pipeThickness - 4;
            cycleCtx.setLineDash([10, 10]);
            cycleCtx.stroke();
            cycleCtx.setLineDash([]);

            // Componentes
            const condenserWidth = 120, condenserHeight = 60;
            const evaporatorWidth = 120, evaporatorHeight = 60;
            const compressorWidth = 72, compressorHeight = 72;
            const expansionWidth = 72, expansionHeight = 36;

            const condenserX = (x1 + x2) / 2 - condenserWidth / 2;
            const condenserY = y1 + pipeThickness / 2 - condenserHeight / 2;
            if (condenserImg.complete) cycleCtx.drawImage(condenserImg, condenserX, condenserY, condenserWidth, condenserHeight);
            drawFan(cycleCtx, condenserX + condenserWidth / 4, condenserY + condenserHeight / 2, fanAngle);
            drawFan(cycleCtx, condenserX + 3 * condenserWidth / 4, condenserY + condenserHeight / 2, fanAngle);

            const evaporatorX = (x1 + x2) / 2 - evaporatorWidth / 2;
            const evaporatorY = y2 - pipeThickness / 2 - evaporatorHeight / 2;
            if (evaporatorImg.complete) cycleCtx.drawImage(evaporatorImg, evaporatorX, evaporatorY, evaporatorWidth, evaporatorHeight);
            drawFan(cycleCtx, evaporatorX + evaporatorWidth / 4, evaporatorY + evaporatorHeight / 2, fanAngle);
            drawFan(cycleCtx, evaporatorX + 3 * evaporatorWidth / 4, evaporatorY + evaporatorHeight / 2, fanAngle);

            const compressorX = x2 - pipeThickness / 2 - compressorWidth / 2;
            const compressorY = (y1 + y2) / 2 - compressorHeight / 2;
            if (compressorImg.complete) cycleCtx.drawImage(compressorImg, compressorX, compressorY, compressorWidth, compressorHeight);

            const expansionX = x1 + pipeThickness / 2 - expansionWidth / 2;
            const expansionY = (y1 + y2) / 2 - expansionHeight / 2;
            if (expansionImg.complete) cycleCtx.drawImage(expansionImg, expansionX, expansionY, expansionWidth, expansionHeight);
        }

        let mouseX = -100, mouseY = -100;
        let hoveredPoint = null;

        phCanvas.addEventListener('mousemove', (event) => {
            const rect = phCanvas.getBoundingClientRect();
            mouseX = event.clientX - rect.left;
            mouseY = event.clientY - rect.top;
            drawPHDiagram();
        });

        phCanvas.addEventListener('mouseout', () => {
            mouseX = -100;
            mouseY = -100;
            hoveredPoint = null;
            drawPHDiagram();
        });

        function getPointsPH() {
            const cyclePoints = [
                thermoData.points['1'],
                thermoData.points['2'],
                thermoData.points['3'],
                thermoData.points['4']
            ];
            const cyclePressures = cyclePoints.map(p => p.pressure);
            const cycleEnthalpies = cyclePoints.map(h => h.enthalpy);

            const minP = Math.min(...cyclePressures) * 0.8;
            const maxP = Math.max(...cyclePressures) * 1.2;
            const minH = Math.min(...cycleEnthalpies) * 0.9;
            const maxH = Math.max(...cycleEnthalpies) * 1.1;

            const marginX = 32.4, marginY = 25.92;
            const plotWidth = 324 - 2 * marginX;
            const plotHeight = 233 - 2 * marginY;

            function scaleX(h) { return marginX + (h - minH) / (maxH - minH) * plotWidth; }
            function scaleY(p) { return marginY + plotHeight - (Math.log(p) - Math.log(minP)) / (Math.log(maxP) - Math.log(minP)) * plotHeight; }

            return [
                { x: scaleX(cyclePoints[0].enthalpy), y: scaleY(cyclePoints[0].pressure), label: '1', temp: cyclePoints[0].temperature },
                { x: scaleX(cyclePoints[1].enthalpy), y: scaleY(cyclePoints[1].pressure), label: '2', temp: cyclePoints[1].temperature },
                { x: scaleX(cyclePoints[2].enthalpy), y: scaleY(cyclePoints[2].pressure), label: '3', temp: cyclePoints[2].temperature },
                { x: scaleX(cyclePoints[3].enthalpy), y: scaleY(cyclePoints[3].pressure), label: '4', temp: cyclePoints[3].temperature }
            ];
        }

        function drawPHDiagram() {
            const pixelRatio = window.devicePixelRatio || 1;
            phCanvas.width = 324 * pixelRatio;
            phCanvas.height = 233 * pixelRatio;
            phCtx.scale(pixelRatio, pixelRatio);

            phCtx.clearRect(0, 0, 324, 233);

            const marginX = 32.4, marginY = 25.92;
            const plotWidth = 324 - 2 * marginX;
            const plotHeight = 233 - 2 * marginY;

            const cyclePoints = [thermoData.points['1'], thermoData.points['2'], thermoData.points['3'], thermoData.points['4']];
            const cyclePressures = cyclePoints.map(p => p.pressure);
            const cycleEnthalpies = cyclePoints.map(h => h.enthalpy);

            const minP = Math.min(...cyclePressures) * 0.8;
            const maxP = Math.max(...cyclePressures) * 1.2;
            const minH = Math.min(...cycleEnthalpies) * 0.9;
            const maxH = Math.max(...cycleEnthalpies) * 1.1;

            function scaleX(h) { return marginX + (h - minH) / (maxH - minH) * plotWidth; }
            function scaleY(p) { return marginY + plotHeight - (Math.log(p) - Math.log(minP)) / (Math.log(maxP) - Math.log(minP)) * plotHeight; }

            phCtx.beginPath();
            phCtx.moveTo(marginX, marginY);
            phCtx.lineTo(marginX, marginY + plotHeight);
            phCtx.lineTo(marginX + plotWidth, marginY + plotHeight);
            phCtx.strokeStyle = 'black';
            phCtx.lineWidth = 1.08;
            phCtx.stroke();

            phCtx.font = '14.4px Arial';
            phCtx.fillStyle = 'black';
            phCtx.fillText('Presión (bar)', marginX - 32.4, marginY - 10);
            phCtx.fillText('Entalpía (kJ/kg)', marginX + plotWidth - 80, marginY + plotHeight + 15);

            const 
   
logMinP = Math.log(minP);
            const logMaxP = Math.log(maxP);
            const numPressureTicks = 6;
            for (let i = 0; i < numPressureTicks; i++) {
                const logP = logMinP + (logMaxP - logMinP) * i / (numPressureTicks - 1);
                const p = Math.exp(logP);
                const y
