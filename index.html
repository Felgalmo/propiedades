<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refrigeration Cycle Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
        }
        .form-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .results-section {
            margin-top: 20px;
        }
        .error-message {
            color: red;
            display: none;
        }
        .capillary-table {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Refrigeration Cycle Simulator</h1>
        <div class="form-section">
            <form id="thermo-form">
                <div class="mb-3">
                    <label for="refrigerant" class="form-label">Refrigerant</label>
                    <select id="refrigerant" class="form-select" required>
                        <option value="">Select a refrigerant</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="evap_temp" class="form-label">Evaporator Temperature (K)</label>
                    <input type="number" id="evap_temp" class="form-control" value="243.15" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="cond_temp" class="form-label">Condenser Temperature (K)</label>
                    <input type="number" id="cond_temp" class="form-control" value="313.15" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="superheat" class="form-label">Superheat (K)</label>
                    <input type="number" id="superheat" class="form-control" value="0" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="subcooling" class="form-label">Subcooling (K)</label>
                    <input type="number" id="subcooling" class="form-control" value="0" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="cooling_power" class="form-label">Cooling Power</label>
                    <div class="input-group">
                        <input type="number" id="cooling_power" class="form-control" value="1000" step="1" required>
                        <select id="cooling_unit" class="form-select">
                            <option value="W">Watts</option>
                            <option value="Btu/h">Btu/h</option>
                            <option value="kcal/h">kcal/h</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Calculate</button>
            </form>
            <div id="error-message" class="error-message mt-3"></div>
        </div>
        <div id="results" class="results-section"></div>
    </div>

    <script>
        // Mapa de diámetros comerciales (en metros) a pulgadas para visualización
        const COMMERCIAL_DIAMETERS_INCHES = {
            0.0007112: 0.028,
            0.0007874: 0.031,
            0.0008382: 0.033,
            0.0009144: 0.036,
            0.0009906: 0.039,
            0.0010668: 0.042,
            0.0011176: 0.044,
            0.0011938: 0.047,
            0.0012446: 0.049,
            0.0013208: 0.052,
            0.001397: 0.055,
            0.0014986: 0.059,
            0.0016256: 0.064,
            0.001778: 0.070
        };

        // Cargar refrigerantes al iniciar
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/refrigerants');
                const data = await response.json();
                if (data.status === 'success') {
                    const refrigerantSelect = document.getElementById('refrigerant');
                    data.refrigerants.forEach(ref => {
                        const option = document.createElement('option');
                        option.value = ref;
                        option.textContent = ref;
                        refrigerantSelect.appendChild(option);
                    });
                } else {
                    showError('Error loading refrigerants: ' + data.message);
                }
            } catch (error) {
                showError('Error fetching refrigerants: ' + error.message);
            }
        });

        // Manejar envío del formulario
        document.getElementById('thermo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();
            clearResults();

            const refrigerant = document.getElementById('refrigerant').value;
            const evap_temp = parseFloat(document.getElementById('evap_temp').value);
            const cond_temp = parseFloat(document.getElementById('cond_temp').value);
            const superheat = parseFloat(document.getElementById('superheat').value);
            const subcooling = parseFloat(document.getElementById('subcooling').value);
            const cooling_power = parseFloat(document.getElementById('cooling_power').value);
            const cooling_unit = document.getElementById('cooling_unit').value;

            try {
                const response = await fetch('/thermo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        refrigerant,
                        evap_temp,
                        cond_temp,
                        superheat,
                        subcooling,
                        cooling_power: { value: cooling_power, unit: cooling_unit }
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    displayResults(data);
                } else {
                    showError('Error del servidor: ' + data.message);
                }
            } catch (error) {
                showError('Error en la solicitud: ' + error.message);
            }
        });

        // Mostrar error
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Limpiar error
        function clearError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }

        // Limpiar resultados
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Mostrar resultados
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>Resultados</h3>
                <p><strong>Refrigerante:</strong> ${data.refrigerant}</p>
                <p><strong>COP:</strong> ${data.cop.toFixed(2)}</p>
                <p><strong>Caudal másico:</strong> ${data.mass_flow.toFixed(4)} kg/s</p>
                <h4>Puntos del Ciclo</h4>
                <ul>
                    <li>Punto 1: Presión = ${(data.points['1'].pressure / 100000).toFixed(2)} bar, Entalpía = ${(data.points['1'].enthalpy / 1000).toFixed(2)} kJ/kg, Temperatura = ${(data.points['1'].temperature - 273.15).toFixed(2)} °C</li>
                    <li>Punto 2: Presión = ${(data.points['2'].pressure / 100000).toFixed(2)} bar, Entalpía = ${(data.points['2'].enthalpy / 1000).toFixed(2)} kJ/kg, Temperatura = ${(data.points['2'].temperature - 273.15).toFixed(2)} °C</li>
                    <li>Punto 3: Presión = ${(data.points['3'].pressure / 100000).toFixed(2)} bar, Entalpía = ${(data.points['3'].enthalpy / 1000).toFixed(2)} kJ/kg, Temperatura = ${(data.points['3'].temperature - 273.15).toFixed(2)} °C</li>
                    <li>Punto 4: Presión = ${(data.points['4'].pressure / 100000).toFixed(2)} bar, Entalpía = ${(data.points['4'].enthalpy / 1000).toFixed(2)} kJ/kg, Temperatura = ${(data.points['4'].temperature - 273.15).toFixed(2)} °C</li>
                </ul>
            `;

            // Crear tabla de longitudes capilares
            const table = document.createElement('table');
            table.className = 'table table-bordered capillary-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Diámetro (pulgadas)</th>
                        <th>Longitud (metros)</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.capillary_lengths.map(item => `
                        <tr>
                            <td>${COMMERCIAL_DIAMETERS_INCHES[item.diameter_mm / 1000].toFixed(3)}</td>
                            <td>${typeof item.length_m === 'number' ? item.length_m.toFixed(2) : item.length_m}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            resultsDiv.appendChild(table);
        }
    </script>
</body>
</html>
